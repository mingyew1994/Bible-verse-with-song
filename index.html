<script>
  /* ---------- 1. Bible verse (unchanged) ---------- */
  async function loadVerse(){
    const verseEl=document.getElementById("verse");
    const refEl =document.getElementById("reference");
    const errEl =document.getElementById("error");
    try{
      const res=await fetch("https://beta.ourmanna.com/api/v1/get/?format=json&order=random&t="+Date.now());
      const d=await res.json();
      verseEl.textContent=d.verse.details.text;
      refEl.textContent  =d.verse.details.reference;
    }catch{
      verseEl.textContent="⚠️ Unable to load verse.";
      errEl.textContent ="Check your connection and try again.";
    }
  }
  loadVerse();

  /* ---------- 2. Random MP3 background ---------- */
  const tracks=["song1.mp3","song2.mp3","song3.mp3","song4.mp3","song5.mp3"];
  const chosen=tracks[Math.floor(Math.random()*tracks.length)];

  const bgm=document.getElementById("bgm");
  bgm.src=chosen;

  const playBtn=document.getElementById("playBtn");

  /* ✨ Helper: detect Safari (needs double play) */
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

  async function startMusic(){
    try{
      bgm.muted=true;
      await bgm.play();                // first (and only) play for most browsers
      if(isSafari){                    // ✨ only Safari needs the second call
        await bgm.play();
      }
      bgm.addEventListener("canplay",()=>bgm.muted=false,{once:true});
      playBtn.style.display="none";
      localStorage.setItem("bgm-ok","yes");
    }catch{
      bgm.controls=true;
      alert("Autoplay blocked. Press the play icon.");
    }
  }
  playBtn.addEventListener("click",startMusic);

  /* ---------- 3. Try autoplay if user consented ---------- */
  if(localStorage.getItem("bgm-ok")==="yes"){
    bgm.muted=true;
    bgm.play()
      .then(()=>{ bgm.muted=false; playBtn.style.display="none"; })
      .catch(()=>{/* keep button visible if blocked */});
  }
</script>
